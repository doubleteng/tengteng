<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Publications | Teng Teng</title>
<meta name="description" content="Publications by Teng Teng: journals, conferences, books, theses, patents.">
<style>
  :root{--bg:#fff;--text:#111827;--sub:#6b7280;--border:#e5e7eb;--shadow:0 8px 24px rgba(0,0,0,.06);--radius:18px;--chip:#f3f4f6}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Noto Sans,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
  a{color:var(--text);text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:1080px;margin:0 auto;padding:24px}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 0 8px;position:sticky;top:0;background:rgba(255,255,255,.88);backdrop-filter:blur(8px);z-index:10;border-bottom:1px solid var(--border)}
  .brand{display:flex;align-items:center;gap:12px;font-weight:800}
  .brand .logo{width:36px;height:36px;border-radius:12px;background:#111827;color:#fff;display:grid;place-items:center;box-shadow:0 6px 18px rgba(0,0,0,.08)}
  nav.menu>ul{list-style:none;margin:0;padding:0;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  nav.menu>ul>li>a{color:var(--sub);font-weight:600;display:inline-block;padding:6px 10px;border-radius:8px}
  nav.menu>ul>li>a:hover{color:var(--text);background:#f3f4f6}

  h1{font-size:clamp(26px,3.6vw,40px);margin:14px 0 8px}
  .sub{color:var(--sub)}

  .toolbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:12px 0 14px;flex-wrap:wrap}
  .types{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--border);border-radius:12px;padding:8px 12px;background:#fff;font-weight:700}
  .btn[aria-pressed="true"]{background:var(--chip)}
  .count{color:var(--sub);font-size:14px}

  .year{margin:18px 0 8px;font-size:20px}
  .list{display:grid;gap:12px;margin-top:6px}
  .item{background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:14px}
  .title{font-weight:800;margin:0 0 6px;font-size:16px}
  .meta{color:var(--sub);font-size:14px;margin:0 0 8px}
  .badges{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 0}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#fff}
  .links{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .links a{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}

  details.bib{margin-top:10px;border:1px dashed var(--border);border-radius:12px;padding:10px;background:#fafafa}
  details.bib summary{cursor:pointer;font-weight:700}
  .bib-actions{display:flex;gap:8px;align-items:center;margin-top:8px}
  .copy-btn{border:1px solid var(--border);border-radius:10px;background:#fff;padding:6px 10px;font-weight:700}
  pre{white-space:pre-wrap;word-break:break-word;margin:8px 0 0}

  .empty{color:var(--sub);border:1px dashed var(--border);border-radius:12px;padding:16px;text-align:center}
  footer{color:var(--sub);font-size:13px;text-align:center;padding:28px 0 12px;margin-top:24px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand"><div class="logo">TT</div><span>Teng Teng</span></div>
    <nav class="menu" aria-label="Primary">
      <ul>
        <li><a href="../">Home</a></li>
        <li><a href="../research/">Research</a></li>
        <li><a href="../teaching/">Teaching</a></li>
        <li><a href="../design/">Design</a></li>
        <li><a href="./">Publications</a></li>
        <li><a href="../news/">News</a></li>
        <li><a href="../about/">About</a></li>
        <li><a href="../contact/">Contact</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h1>Publications</h1>
    <div class="sub">Peer-reviewed articles, conference papers, book chapters, theses, and patents.</div>

    <div class="toolbar">
      <div class="types" role="tablist" aria-label="Type filter">
        <button class="btn" data-type="all" aria-pressed="true">All</button>
        <button class="btn" data-type="journal" aria-pressed="false">Journal</button>
        <button class="btn" data-type="conference" aria-pressed="false">Conference</button>
        <button class="btn" data-type="book" aria-pressed="false">Book</button>
        <button class="btn" data-type="thesis" aria-pressed="false">Thesis</button>
        <button class="btn" data-type="patent" aria-pressed="false">Patent</button>
        <button class="btn" data-type="inreview" aria-pressed="false">In Review</button>
      </div>
      <div class="count" id="count"></div>
    </div>

    <div id="container"></div>
  </main>

  <footer>© <span id="year"></span> Teng Teng</footer>
</div>

<!-- 只加载 BibTeX 数据源 -->
<script src="../assets/js/pubs.js"></script>
<script>
document.getElementById('year').textContent=new Date().getFullYear();

/* ------------------ BibTeX 解析（轻量级） ------------------ */
function parseBibtexEntry(bib){
  // 获取类型与 key
  const head = bib.match(/@\s*([a-zA-Z]+)\s*{\s*([^,]+),/s);
  const typeRaw = head ? head[1].toLowerCase() : '';
  const citekey = head ? head[2].trim() : '';

  // 获取字段块（首逗号后到最后右大括号前）
  const bodyStart = bib.indexOf('{', bib.indexOf('@')) + 1;
  const body = bib.slice(bodyStart, bib.lastIndexOf('}'));

  // 在顶层深度分割字段（支持 {…} / "…" 包裹的值中出现逗号）
  let i=0, depth=0, token='', parts=[];
  let inQuote=false;
  while(i<body.length){
    const ch = body[i];
    if(ch === '"' && body[i-1] !== '\\'){ inQuote = !inQuote; token+=ch; i++; continue; }
    if(!inQuote){
      if(ch === '{') depth++;
      if(ch === '}') depth = Math.max(0, depth-1);
      if(ch === ',' && depth===0){ parts.push(token.trim()); token=''; i++; continue; }
    }
    token += ch; i++;
  }
  if(token.trim()) parts.push(token.trim());

  const fields = {};
  for(const p of parts){
    const eq = p.indexOf('=');
    if(eq===-1) continue;
    const k = p.slice(0,eq).trim().toLowerCase();
    let v = p.slice(eq+1).trim();
    // 去掉外围 { } 或 " "
    if(v.startsWith('{') && v.endsWith('}')) v = v.slice(1,-1);
    else if(v.startsWith('"') && v.endsWith('"')) v = v.slice(1,-1);
    fields[k]=v;
  }

  // 清理 LaTeX（最小化处理），并返回渲染需要的字段
  const cleanTex = s => (s||'')
    .replace(/\\bf\s*/gi,'')     // \bf
    .replace(/\\textbf\s*/gi,'') // \textbf
    .replace(/[{}]/g,'');        // braces

  const title   = cleanTex(fields.title||'').trim();
  const authors = cleanTex(fields.author||'').trim();
  const journal = cleanTex(fields.journal||'').trim();
  const book    = cleanTex(fields.booktitle||'').trim();
  const school  = cleanTex(fields.school||'').trim();
  const publ    = cleanTex(fields.publisher||'').trim();
  const note    = cleanTex(fields.note||'').trim();
  const url     = (fields.url||fields.URL||'').trim();

  // 年份：可能是 In progress，或含日期；提取 4 位年份
  let year = 0; 
  const ym = (fields.year||'').match(/\d{4}/);
  if(ym) year = parseInt(ym[0],10);

  // 类型映射（用于 UI 过滤）
  let uiType = 'inreview';
  if(typeRaw==='article') uiType='journal';
  else if(typeRaw==='inproceedings') uiType='conference';
  else if(typeRaw==='phdthesis' || typeRaw==='mastersthesis') uiType='thesis';
  else if(typeRaw==='incollection') uiType='book';
  else if(typeRaw==='misc') uiType='patent';

  // 期刊/会议/机构等，择优作为 venue
  const venue = journal || book || school || publ;

  // DOI：若 url 看起来是 DOI
  const doi = /^https?:\/\/(dx\.)?doi\.org\/|^10\./i.test(url) ? url : '';

  return {
    typeRaw, citekey, title, authors, venue, year, note,
    url, doi, uiType,
    bibtex: bib.trim()
  };
}

/* ------------------ UI 渲染 ------------------ */
(function(){
  const dataRaw = (window.PUBS_BIB || []).map(parseBibtexEntry);

  const LABEL = {
    journal: 'Journal',
    conference: 'Conference',
    book: 'Book',
    thesis: 'Thesis',
    patent: 'Patent',
    inreview: 'In Review'
  };

  const container = document.getElementById('container');
  const count = document.getElementById('count');
  const buttons = Array.from(document.querySelectorAll('[data-type]'));

  let activeType = (new URLSearchParams(location.search).get('type')) || 'all';
  if(!['all','journal','conference','book','thesis','patent','inreview'].includes(activeType)) activeType='all';
  setPressed(buttons.find(b=>b.dataset.type===activeType));

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      setPressed(btn);
      activeType = btn.dataset.type;
      const url = new URL(location.href);
      url.searchParams.set('type', activeType);
      history.replaceState(null,'',url.toString());
      render();
    });
  });

  function setPressed(target){ buttons.forEach(b=>b.setAttribute('aria-pressed', String(b===target))); }
  function byYearDesc(a,b){ return (b.year||0)-(a.year||0); }
  function boldMe(s){
    if(!s) return '';
    return s
      .replace(/Teng,\s*Teng/gi, '<strong>Teng, Teng</strong>')
      .replace(/\bTeng\s+Teng\b/gi, '<strong>Teng Teng</strong>');
  }
  function itemHTML(r){
    const t = r.title || '(Untitled)';
    const venue = r.venue ? ` — <em>${r.venue}</em>` : '';
    const note  = r.note ? ` · ${r.note}` : '';
    const badge = `<span class="badge">${LABEL[r.uiType] || r.uiType}</span>`;

    const links = [];
    if(r.doi) links.push(`<a href="${r.doi}" target="_blank" rel="noopener">DOI</a>`);
    if(r.url && !r.doi) links.push(`<a href="${r.url}" target="_blank" rel="noopener">Link</a>`);

    const titleLink = (r.doi || r.url) ? `<a href="${r.doi || r.url}" target="_blank" rel="noopener">${t}</a>` : t;

    return `
      <article class="item">
        <h3 class="title">${titleLink}</h3>
        <p class="meta">${boldMe(r.authors)}${venue}${note}${r.year? ' · '+r.year : ''}</p>
        <div class="badges">${badge}${links.length? `<div class="links">${links.join('')}</div>` : ''}</div>
        <details class="bib"><summary>BibTeX</summary>
          <div class="bib-actions">
            <button class="copy-btn" data-copy="${encodeURIComponent(r.bibtex)}">Copy</button>
          </div>
          <pre>${r.bibtex.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>
        </details>
      </article>
    `;
  }

  function groupByYear(list){
    const map = new Map();
    list.forEach(x=>{
      const y = x.year || 0;
      if(!map.has(y)) map.set(y, []);
      map.get(y).push(x);
    });
    return Array.from(map.entries()).sort((a,b)=>b[0]-a[0]); // 年份降序
  }

  function render(){
    let list = dataRaw.slice();
    if(activeType!=='all'){ list = list.filter(x=>x.uiType===activeType); }
    list.sort(byYearDesc);

    if(!list.length){
      container.innerHTML = `<div class="empty">No publications found for this filter.</div>`;
      count.textContent = '0 items';
      return;
    }

    const html = groupByYear(list).map(([yr, items])=>{
      const section = items.map(itemHTML).join('');
      return `<h2 class="year">${yr||'No year'}</h2><div class="list">${section}</div>`;
    }).join('');

    container.innerHTML = html;
    count.textContent = `${list.length} item${list.length>1?'s':''}`;

    // 复制按钮
    container.querySelectorAll('.copy-btn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const txt = decodeURIComponent(btn.getAttribute('data-copy'));
        try{
          await navigator.clipboard.writeText(txt);
          btn.textContent = 'Copied';
          setTimeout(()=>btn.textContent='Copy',1200);
        }catch(_){
          btn.textContent = 'Select & Copy';
          setTimeout(()=>btn.textContent='Copy',1500);
        }
      });
    });
  }

  render();
})();
</script>
</body>
</html>
