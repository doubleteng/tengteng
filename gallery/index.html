<script src="../assets/js/projects.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear();

  const BASE = "../";
  const buttons = Array.from(document.querySelectorAll('.cats [data-cat]'));
  const tagbar = document.getElementById('tagbar');
  const grid   = document.getElementById('grid');
  const count  = document.getElementById('count');

  const ALL_TAGS = ["computation","material","fabrication","robotics","architecture","product","interface","research","teaching","design"]; // 单选
  let activeCat = getCatFromQuery() || "all";
  let activeTag = null;

  setPressed(buttons.find(b => b.dataset.cat === activeCat));

  // 新增：安全拼图片路径（支持根相对 /assets/... 和相对 assets/...）
  function imgUrl(p){
    if(!p || !p.img) return '';
    return p.img.startsWith('/') ? p.img : (BASE + p.img);
  }

  // 新增：健壮的年份解析（兼容 "2015–2021"）
  function yearVal(y){
    if(typeof y === 'number') return y;
    if(typeof y === 'string'){
      const m = y.match(/\d{4}/); // 取第一个年份
      return m ? parseInt(m[0],10) : 0;
    }
    return 0;
  }
  function byYearDesc(a,b){ return yearVal(b.year) - yearVal(a.year); }

  ALL_TAGS.forEach(t=>{
    const b=document.createElement('button');
    b.className='chip'; b.textContent=cap(t);
    b.setAttribute('data-tag',t); b.setAttribute('aria-pressed','false');
    b.addEventListener('click', ()=>{
      if(activeTag===t){ activeTag=null; setAllTags(false); }
      else{ activeTag=t; setOnlyTag(t); }
      render();
    });
    tagbar.appendChild(b);
  });
  document.getElementById('clear').addEventListener('click', ()=>{ activeTag=null; setAllTags(false); render(); });

  buttons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      setPressed(btn);
      activeCat = btn.dataset.cat;
      const url = new URL(location.href);
      url.searchParams.set('cat', activeCat);
      history.replaceState(null,'',url.toString());
      render();
    });
  });

  function setPressed(target){ buttons.forEach(b=>b.setAttribute('aria-pressed', String(b===target))); }
  function setAllTags(v){ tagbar.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed', v?'true':'false')); }
  function setOnlyTag(t){ tagbar.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed', c.getAttribute('data-tag')===t?'true':'false')); }
  function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}
  function getCatFromQuery(){
    const p=new URLSearchParams(location.search).get('cat');
    return (["all","research","teaching","design"].includes(p||"")) ? p : null;
  }

  function metaLine(primary, p){
    const omit = new Set(['research','design','teaching']);
    const tags = (p.tags||[]).filter(t => !omit.has(String(t).toLowerCase()));
    const t = tags.length ? ' · ' + tags.map(cap).join(' · ') : '';
    const y = p.year ? ' · ' + p.year : '';
    return (primary ? cap(primary) : '') + t + y;
  }

  function card(p){
    const primary = (p.cats && p.cats[0]) ? p.cats[0] : '';
    return `<a class="card" href="${BASE}${p.url}">
      <div class="thumb" style="background-image:url('${imgUrl(p)}')"></div>
      <div class="meta"><h3>${p.title}</h3><p>${metaLine(primary, p)}</p></div>
    </a>`;
  }

  function render(){
    let list = Array.isArray(window.PROJECTS) ? window.PROJECTS.slice() : [];
    if(activeCat !== "all"){ list = list.filter(p => (p.cats||[]).includes(activeCat)); }
    if(activeTag){ list = list.filter(p => (p.tags||[]).includes(activeTag)); }
    list.sort(byYearDesc);
    grid.innerHTML = list.map(card).join('');
    count.textContent = `${list.length} projects`;
  }

  render();
});
</script>
